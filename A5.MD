# A5: Relational Schema, validation and schema refinement
 
 
## 1. Relational Schema
 
<table>
    <tr>
        <th>Relation reference</th>
        <th>Relation Compact Notation</th>
    </tr>
    <tr>
        <td>R01</td>
        <td>user(<u>id</u>,
				email <strong>UK NN</strong>,
				username <strong>UK NN</strong>,
				birthdate <strong>CK</strong> birthdate &lt; register_date,
				password <strong>NN</strong>,
				name,
				register_date <strong>NN DF</strong> Today,
				description,
				last_login <strong>CK</strong> last_login &gt; register_date,
				type <strong>NN CK</strong> type <strong>IN</strong> UserType)
        </td>
    </tr>
    <tr>
        <td>R02</td>
        <td>following(<u>follower_id</u> → user, <u>followed_id</u> → user, date <strong>NN DF</strong> Today)</td>
    </tr>
    <tr>
        <td>R03</td>
        <td>country(<u>id</u>,
                name <strong>NN</strong>)
        </td>
    </tr>
    <tr>
        <td>R04</td>
        <td>city(<u>id</u>,
                name <strong>NN</strong>,
				country_id → country)
        </td>
    </tr>
    <tr>
        <td>R05</td>
        <td>university(<u>id</u>,
                name <strong>UK NN</strong>,
                description <strong>NN</strong>,
				country_id → country)
        </td>
    </tr>
    <tr>
        <td>R06</td>
        <td>faculty(<u>id</u>,
                name <strong>UK NN</strong>,
                description <strong>NN</strong>,
				city_id → city, university_id → university)
        </td>
    </tr>
    <tr>
        <td>R07</td>
        <td>post(<u>id</u>,
                title <strong>NN</strong>,
                /votes,
                content <strong>NN</strong>,
                school_year <strong>NN</strong>,
                date <strong>NN DF</strong> Today,
				removed_reason,
                removed_date <strong>CK</strong> date &lt; removed_date,
				author_id → user,
				from_faculty_id → faculty,
				to_faculty_id → faculty)
        </td>
    </tr>
    <tr>
        <td>R08</td>
        <td>comment(<u>id</u>,
                content <strong>NN</strong>,
                date <strong>NN DF</strong> Today,
				removed_reason,
                removed_date <strong>CK</strong> date &lt; removed_date,
				post_id → post, 
				author_id → user)
        </td>
    </tr>
    <tr>
        <td>R09</td>
        <td>flag_user(<u>flagger_id</u> → user,
				<u>flagged_id</u> → user,
                reason <strong>NN</strong>,
                date <strong>NN DF</strong> Today)
        </td>
    </tr>
    <tr>
        <td>R10</td>
        <td>flag_comment(<u>flagger_id</u> → user,
				<u>comment_id</u> → comment,
                reason <strong>NN</strong>,
                date <strong>NN DF</strong> Today)
        </td>
    </tr>
    <tr>
        <td>R11</td>
        <td>flag_post(<u>flagger_id</u> → user,
				<u>post_id</u> → post,
                reason <strong>NN</strong>,
                date <strong>NN DF</strong> Today)
        </td>
    </tr>
    <tr>
        <td>R12</td>
        <td>vote(<u>user_id</u> → user,
				<u>post_id</u> → post)
        </td>
    </tr>
</table>
 
 
where UK means UNIQUE KEY, NN means NOT NULL, DF means DEFAULT and CK means CHECK.

## 2. Domains
 
The specification of additional domains can also be made in a compact form, using the notation:
 
 
<table>
    <tr>
        <th>Domain Name</th>
        <th>Domain Specification</th>
    </tr>
    <tr>
        <td>Today</td>
        <td>DATE DEFAULT CURRENT_DATE</td>
    </tr>
    <tr>
        <td>UserType</td>
        <td>ENUM ('active', 'banned', 'admin')</td>
    </tr>
</table>
 
 
## 3. Functional Dependencies and Schema Validation

<table>
	<tr><td colspan=2><strong>Table R01</strong> (user)</td></tr>
	<tr><td colspan=2><strong>Keys: </strong> {id}, {email}, {username}</td></tr>
	<tr><td colspan=2><strong>Functional Dependencies</strong></td></tr>
	<tr>
		<td>FD0101</td>
		<td>{id} → {email,username, birthdate, password, name, register_date, description, last_login, type}</td>
	</tr>
	<tr>
		<td>FD0102</td>
		<td>{email} → {id, username, birthdate, password, name, register_date, description, last_login, type}</td>
	</tr>
	<tr>
		<td>FD0102</td>
		<td>{username} → {id, email, birthdate, password, name, register_date, description, last_login, type}</td>
	</tr>
	<tr><th>Normal Form</th><td>BCNF</td></tr>
</table>
 
 
<table>
	<tr><td colspan=2><strong>Table R02</strong> (following)</td></tr>
	<tr><td colspan=2><strong>Keys:</strong> {follower_id, following_id}</td></tr>
	<tr><td colspan=2><strong>Functional Dependencies</strong></td></tr>
	<tr>
		<td>FD0201</td>
		<td>{follower_id, following_id} → {date}</td>
	</tr>
	<tr><th>Normal Form</th><td>BCNF</td></tr>
</table>


<table>
	<tr><td colspan=2><strong>Table R03</strong> (country)</td></tr>
	<tr><td colspan=2><strong>Keys:</strong> {id}, {name}</td></tr>
	<tr><td colspan=2><strong>Functional Dependencies</strong></td></tr>
	<tr>
		<td>FD0301</td>
		<td>{id} → {name}</td>
    </tr>
    <tr>
        <td>FD0302</td>
        <td>{name} → {id}</td>
	</tr>
	<tr><th>Normal Form</th><td>BCNF</td></tr>
</table>

<table>
	<tr><td colspan=2><strong>Table R04</strong> (city)</td></tr>
	<tr><td colspan=2><strong>Keys:</strong> {id}</td></tr>
	<tr><td colspan=2><strong>Functional Dependencies</strong></td></tr>
	<tr>
		<td>FD0401</td>
		<td>{id} → {name, country_id}</td>
	</tr>
	<tr><th>Normal Form</th><td>BCNF</td></tr>
</table>

<table>
	<tr><td colspan=2><strong>Table R05</strong> (university)</td></tr>
	<tr><td colspan=2><strong>Keys:</strong> {id}, {name}</td></tr>
	<tr><td colspan=2><strong>Functional Dependencies</strong></td></tr>
	<tr>
		<td>FD0501</td>
		<td>{id} → {name, description, country_id}</td>
    </tr>
    <tr>
        <td>FD0502</td>
        <td>{name} → {id, description, country_id}</td>
	</tr>
	<tr><th>Normal Form</th><td>BCNF</td></tr>
</table>

<table>
	<tr><td colspan=2><strong>Table R06</strong> (faculty)</td></tr>
	<tr><td colspan=2><strong>Keys:</strong> {id}, {name}</td></tr>
	<tr><td colspan=2><strong>Functional Dependencies</strong></td></tr>
	<tr>
		<td>FD0601</td>
		<td>{id} → {name, description, city_id}</td>
    </tr>
    <tr>
        <td>FD0602</td>
        <td>{name} → {id, description, city_id}</td>
	</tr>
	<tr><th>Normal Form</th><td>BCNF</td></tr>
</table>

<table>
	<tr><td colspan=2><strong>Table R07</strong> (post)</td></tr>
	<tr><td colspan=2><strong>Keys:</strong> {id}</td></tr>
	<tr><td colspan=2><strong>Functional Dependencies</strong></td></tr>
	<tr>
		<td>FD0701</td>
		<td>{id} → {title, /votes, content, school_year, date, removed_reason, removed_date, author_id, from_faculty_id, to_faculty_id}</td>
	</tr>
	<tr><th>Normal Form</th><td>BCNF</td></tr>
</table>

<table>
	<tr><td colspan=2><strong>Table R08</strong> (comment)</td></tr>
	<tr><td colspan=2><strong>Keys:</strong> {id}</td></tr>
	<tr><td colspan=2><strong>Functional Dependencies</strong></td></tr>
	<tr>
		<td>FD0801</td>
		<td>{id} → {content, date, removed_reason, removed_date, post_id, author_id}</td>
	</tr>
	<tr><th>Normal Form</th><td>BCNF</td></tr>
</table>

<table>
	<tr><td colspan=2><strong>Table R09</strong> (flag_user)</td></tr>
	<tr><td colspan=2><strong>Keys:</strong> {flagger_id, flagged_id}</td></tr>
	<tr><td colspan=2><strong>Functional Dependencies</strong></td></tr>
	<tr>
		<td>FD0901</td>
		<td>{flagger_id, flagged_id} → {reason, date}</td>
	</tr>
	<tr><th>Normal Form</th><td>BCNF</td></tr>
</table>

<table>
	<tr><td colspan=2><strong>Table R10</strong> (flag_comment)</td></tr>
	<tr><td colspan=2><strong>Keys:</strong> {flagger_id, comment_id}</td></tr>
	<tr><td colspan=2><strong>Functional Dependencies</strong></td></tr>
	<tr>
		<td>FD1001</td>
		<td>{flagger_id, comment_id} → {reason, date}</td>
	</tr>
	<tr><th>Normal Form</th><td>BCNF</td></tr>
</table>

<table>
	<tr><td colspan=2><strong>Table R11</strong> (flag_post)</td></tr>
	<tr><td colspan=2><strong>Keys:</strong> {flagger_id, post_id}</td></tr>
	<tr><td colspan=2><strong>Functional Dependencies</strong></td></tr>
	<tr>
		<td>FD1101</td>
		<td>{flagger_id, post_id} → {reason, date}</td>
	</tr>
	<tr><th>Normal Form</th><td>BCNF</td></tr>
</table>

<table>
	<tr><td colspan=2><strong>Table R12</strong> (vote)</td></tr>
	<tr><td colspan=2><strong>Keys:</strong> {user_id, post_id}</td></tr>
	<tr><td colspan=2><strong>Functional Dependencies</strong></td></tr>
	<tr>
		<td colspan=2>(none)</td>
	</tr>
	<tr><th>Normal Form</th><td>BCNF</td></tr>
</table>

 
## 4. SQL Code
 
The SQL code to generate the tables and constraints is displayed bellow. It can also be found on our [GitHub repository](https://github.com/msramalho/lbaw1721/blob/master/artifacts/database.sql).
```sql
CREATE TABLE city (
    id serial NOT NULL,
    name character varying(60) NOT NULL,
    country_id integer NOT NULL
);

ALTER TABLE ONLY city
    ADD CONSTRAINT city_pkey PRIMARY KEY (id);
    
ALTER TABLE ONLY city
    ADD CONSTRAINT city_country_id_fkey FOREIGN KEY (country_id) 
    REFERENCES country(id) ON UPDATE CASCADE ON DELETE CASCADE;


CREATE TABLE comment (
    id serial NOT NULL,
    content text NOT NULL,
    date timestamp with time zone DEFAULT now() NOT NULL,
    removed_reason text,
    removed_date date,
    post_id integer NOT NULL,
    author_id integer NOT NULL,
    CONSTRAINT valid_removed_date CHECK ((date < removed_date))
);

ALTER TABLE ONLY comment
    ADD CONSTRAINT comment_pkey PRIMARY KEY (id);
    
ALTER TABLE ONLY comment
    ADD CONSTRAINT comment_author_id_fkey FOREIGN KEY (author_id)
    REFERENCES "user"(id) ON UPDATE CASCADE ON DELETE CASCADE;

ALTER TABLE ONLY comment
    ADD CONSTRAINT comment_post_id_fkey FOREIGN KEY (post_id)
    REFERENCES post(id) ON UPDATE CASCADE ON DELETE CASCADE;


CREATE TABLE country (
    id serial NOT NULL,
    name character varying(50) NOT NULL,
    code character(2) NOT NULL
);

ALTER TABLE ONLY country
    ADD CONSTRAINT country_pkey PRIMARY KEY (id);


CREATE TABLE faculty (
    id serial NOT NULL,
    name character varying(150) NOT NULL,
    description text NOT NULL,
    city_id integer NOT NULL,
    university_id integer
);

ALTER TABLE ONLY faculty
    ADD CONSTRAINT faculty_pkey PRIMARY KEY (id);
    
ALTER TABLE ONLY faculty
    ADD CONSTRAINT faculty_city_id_fkey FOREIGN KEY (city_id)
    REFERENCES city(id) ON UPDATE CASCADE ON DELETE CASCADE;

ALTER TABLE ONLY faculty
    ADD CONSTRAINT faculty_university_id_key FOREIGN KEY (university_id)
    REFERENCES university(id) ON UPDATE CASCADE ON DELETE CASCADE;


CREATE TABLE flag_comment (
    flagger_id integer NOT NULL,
    comment_id integer NOT NULL,
    reason text NOT NULL,
    date timestamp with time zone DEFAULT now() NOT NULL,
    archived boolean DEFAULT false NOT NULL
);

ALTER TABLE ONLY flag_comment
ADD CONSTRAINT flag_comment_pkey PRIMARY KEY (flagger_id, comment_id);

ALTER TABLE ONLY flag_comment
    ADD CONSTRAINT flag_comment_comment_id_fkey FOREIGN KEY (comment_id)
    REFERENCES comment(id) ON UPDATE CASCADE ON DELETE CASCADE;

ALTER TABLE ONLY flag_comment
    ADD CONSTRAINT flag_comment_flagger_id_fkey FOREIGN KEY (flagger_id)
    REFERENCES "user"(id) ON UPDATE CASCADE ON DELETE CASCADE;


CREATE TABLE flag_post (
    flagger_id integer NOT NULL,
    post_id integer NOT NULL,
    reason text NOT NULL,
    date timestamp with time zone NOT NULL,
    archived boolean DEFAULT false NOT NULL
);

ALTER TABLE ONLY flag_post
    ADD CONSTRAINT flag_post_pkey PRIMARY KEY (flagger_id, post_id);
    
ALTER TABLE ONLY flag_post
    ADD CONSTRAINT flag_post_flagger_id_fkey FOREIGN KEY (flagger_id)
    REFERENCES "user"(id) ON UPDATE CASCADE ON DELETE CASCADE;

ALTER TABLE ONLY flag_post
    ADD CONSTRAINT flag_post_post_id_fkey FOREIGN KEY (post_id)
    REFERENCES post(id) ON UPDATE CASCADE ON DELETE CASCADE;


CREATE TABLE flag_user (
    flagger_id integer NOT NULL,
    flagged_id integer NOT NULL,
    reason text NOT NULL,
    date timestamp with time zone DEFAULT now() NOT NULL,
    archived boolean DEFAULT false NOT NULL,
    CONSTRAINT cannot_flag_oneself CHECK ((flagger_id <> flagged_id))
);

ALTER TABLE ONLY flag_user
    ADD CONSTRAINT flag_user_pkey PRIMARY KEY (flagger_id, flagged_id);
    
ALTER TABLE ONLY flag_user
    ADD CONSTRAINT flag_user_flagged_id_fkey FOREIGN KEY (flagged_id)
    REFERENCES "user"(id) ON UPDATE CASCADE ON DELETE CASCADE;

ALTER TABLE ONLY flag_user
    ADD CONSTRAINT flag_user_flagger_id_fkey FOREIGN KEY (flagger_id)
    REFERENCES "user"(id) ON UPDATE CASCADE ON DELETE CASCADE;


CREATE TABLE following (
    follower_id integer NOT NULL,
    followed_id integer NOT NULL,
    date date DEFAULT now() NOT NULL,
    CONSTRAINT cannot_follow_oneself CHECK ((follower_id <> followed_id))
);

ALTER TABLE ONLY following
    ADD CONSTRAINT following_pkey PRIMARY KEY (follower_id, followed_id);
    
ALTER TABLE ONLY following
    ADD CONSTRAINT following_followed_id_fkey FOREIGN KEY (followed_id)
    REFERENCES "user"(id) ON UPDATE CASCADE ON DELETE CASCADE;

ALTER TABLE ONLY following
    ADD CONSTRAINT following_follower_id_fkey FOREIGN KEY (follower_id)
    REFERENCES "user"(id) ON UPDATE CASCADE ON DELETE CASCADE;


CREATE TABLE post (
    id serial NOT NULL,
    title character varying(200) NOT NULL,
    votes integer DEFAULT 0 NOT NULL,
    content text NOT NULL,
    school_year integer NOT NULL,
    date timestamp with time zone DEFAULT now() NOT NULL,
    removed_reason text,
    removed_date date,
    author_id integer NOT NULL,
    from_faculty_id integer NOT NULL,
    to_faculty_id integer NOT NULL,
    beer_cost character varying(25),
    life_cost character varying(25),
    native_friendliness character varying(25),
    work_load character varying(15),
    CONSTRAINT valid_removed_date CHECK ((date < removed_date))
);

COMMENT ON COLUMN post.votes IS 'Calculated Field';

ALTER TABLE ONLY post
    ADD CONSTRAINT post_pkey PRIMARY KEY (id);

ALTER TABLE ONLY post
    ADD CONSTRAINT post_author_id_fkey FOREIGN KEY (author_id)
    REFERENCES "user"(id) ON UPDATE CASCADE ON DELETE CASCADE;

ALTER TABLE ONLY post
    ADD CONSTRAINT post_from_faculty_id_fkey FOREIGN KEY (from_faculty_id)
    REFERENCES faculty(id) ON UPDATE CASCADE ON DELETE CASCADE;

ALTER TABLE ONLY post
    ADD CONSTRAINT post_to_faculty_id_fkey FOREIGN KEY (to_faculty_id)
    REFERENCES faculty(id) ON UPDATE CASCADE ON DELETE CASCADE;


CREATE TABLE university (
    id serial NOT NULL,
    name character varying(150) NOT NULL,
    description text NOT NULL,
    country_id integer NOT NULL
);
ALTER TABLE ONLY university
    ADD CONSTRAINT university_pkey PRIMARY KEY (id);
    
ALTER TABLE ONLY university
    ADD CONSTRAINT university_country_id_fkey FOREIGN KEY (country_id)
    REFERENCES country(id) ON UPDATE CASCADE ON DELETE CASCADE;


CREATE TABLE "user" (
    id serial NOT NULL,
    email character varying(100) NOT NULL,
    username character varying(100) NOT NULL,
    birthdate date,
    password character varying(60) NOT NULL,
    name character varying(150),
    register_date timestamp with time zone DEFAULT now() NOT NULL,
    description text,
    last_login timestamp with time zone,
    type character varying(50) NOT NULL,
    CONSTRAINT user_type CHECK (((type)::text = ANY (
        ARRAY['active'::text, 'banned'::text, 'admin'::text]))),
    CONSTRAINT valid_birthdate CHECK ((birthdate < register_date)),
    CONSTRAINT valid_last_login CHECK ((last_login > register_date))
);
ALTER TABLE ONLY "user"
    ADD CONSTRAINT user_email_key UNIQUE (email);

ALTER TABLE ONLY "user"
    ADD CONSTRAINT user_pkey PRIMARY KEY (id);

ALTER TABLE ONLY "user"
    ADD CONSTRAINT user_username_key UNIQUE (username);


CREATE TABLE vote (
    user_id integer NOT NULL,
    post_id integer NOT NULL
);

ALTER TABLE ONLY vote
    ADD CONSTRAINT vote_pkey PRIMARY KEY (user_id, post_id);
    
ALTER TABLE ONLY vote
    ADD CONSTRAINT vote_post_id_fkey FOREIGN KEY (post_id)
    REFERENCES post(id) ON UPDATE CASCADE ON DELETE CASCADE;

ALTER TABLE ONLY vote
    ADD CONSTRAINT vote_user_id_fkey1 FOREIGN KEY (user_id)
    REFERENCES "user"(id) ON UPDATE CASCADE ON DELETE CASCADE;

```
 
 
## Revision history
 
1. Initial submission on 21/03/2018
2. Resubmission on 28/03/2018
    * Added missing **NOT NULL**
    * Re-arranged SQL code
    * Changed Keys **{k1,k2}** to **{k1}, {k2}** where applicable

#### GROUP1721, 21/03/2018

>Afonso Ramos - up201506239@fe.up.pt
Daniel Silva - up201503212@fe.up.pt
Miguel Ramalho - up201403027@fe.up.pt
Vitor Minhoto - up201303086@fe.up.pt