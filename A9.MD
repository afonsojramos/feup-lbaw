# A9: Main accesses to the database and transactions
 
## 1. Main Accesses

Main accesses to the database.

### 1.1. M02:User Profile

<table>
	<tr>
		<th>SQL201</th>
		<td>Retreive followers of a user</td>
	</tr>
	<tr>
		<th>Web Resource</th>
		<td><a href="https://hackmd.io/Hk36u2otREmVxBWReAERnA#R201-View-Profile">R201</a></td>
	</tr>
	<tr>
		<td colspan=2>

```sql
SELECT
  follower_id, public.user.username
FROM (following
INNER JOIN public.user ON follower_id = public.user.id)
WHERE followed_id = $user_id;
```
</td>
	</tr>
</table>
<table>
	<tr>
		<th>SQL202</th>
		<td>Retreive users followed by a user</td>
	</tr>
	<tr>
		<th>Web Resource</th>
		<td><a href="https://hackmd.io/Hk36u2otREmVxBWReAERnA#R201-View-Profile">R201</a></td>
	</tr>
	<tr>
		<td colspan=2>

```sql
SELECT
  followed_id, public.user.username
FROM (following
INNER JOIN public.user ON followed_id = public.user.id)
WHERE follower_id = $user_id;
```
</td>
	</tr>
</table>

### 1.2. M03: Posts

<table>
	<tr>
		<th>SQL301</th>
		<td>Search Post</td>
	</tr>
	<tr>
		<th>Web Resource</th>
		<td><a href="https://hackmd.io/Hk36u2otREmVxBWReAERnA#R301-Search-Post-Action">R301</a></td>
	</tr>
	<tr>
		<td colspan=2>

```sql
SELECT p.id, p.title, p.votes, p.content, p.school_year,
p.date, p.removed_date, p.removed_reason, p.date,
u.id AS user_id, u.username AS user_name,
fs.id AS from_faculty_id, fs.name as from_faculty_name,
fd.id AS to_faculty_id, fd.name AS to_faculty_name
  FROM (((post AS p
  INNER JOIN public.user AS u ON p.author_id = u.id)
  INNER JOIN public.faculty AS fs ON p.from_faculty_id = fs.id)
  INNER JOIN public.faculty AS fd ON p.to_faculty_id = fd.id)

WHERE 
(p.search_title || p.search_content) @@ plainto_tsquery('english', 
                                                        $search_query)
ORDER BY ts_rank(
	setweight(u.search_title, 'A') || setweight(u.search_content, 'B'),
	plainto_tsquery('english', $search_query)
) DESC
```
</td>
	</tr>
</table>

<table>
	<tr>
		<th>SQL302</th>
		<td>Get a Post's information, as well as owner's name and faculties' names.</td>
	</tr>
	<tr>
		<th>Web Resource</th>
		<td><a href="https://hackmd.io/Hk36u2otREmVxBWReAERnA#R304-View-Post">R304</a></td>
	</tr>
	<tr>
		<td colspan=2>
			
```sql
SELECT p.id, p.title, p.votes, p.content, p.school_year,
p.date, p.removed_date, p.removed_reason, p.date,
u.id AS user_id, u.username AS user_name,
fs.id AS from_faculty_id, fs.name as from_faculty_name,
fd.id AS to_faculty_id, fd.name AS to_faculty_name
  FROM (((post AS p
  INNER JOIN public.user AS u ON p.author_id = u.id)
  INNER JOIN public.faculty AS fs ON p.from_faculty_id = fs.id)
  INNER JOIN public.faculty AS fd ON p.to_faculty_id = fd.id)
  
  WHERE post.id = $post_id;
```
</td>
	</tr>
</table>

<table>
    <tr>
        <th>SQL303</th>
        <td>Get a Post's information, as well as owner's name and faculties' names by author_id.</td>
    </tr>
    <tr>
        <th>Web Resource</th>
        <td><a href="https://hackmd.io/Hk36u2otREmVxBWReAERnA#R201-View-Profile">R201</a></td>
    </tr>
    <tr>
        <td colspan=2>
			
```sql
SELECT p.id, p.title, p.votes, p.content, p.school_year,
p.date, p.removed_date, p.removed_reason, p.date,
u.id AS user_id, u.username AS user_name,
fs.id AS from_faculty_id, fs.name as from_faculty_name,
fd.id AS to_faculty_id, fd.name AS to_faculty_name
  FROM (((post AS p
  INNER JOIN public.user AS u ON p.author_id = u.id)
  INNER JOIN public.faculty AS fs ON p.from_faculty_id = fs.id)
  INNER JOIN public.faculty AS fd ON p.to_faculty_id = fd.id)
  
  WHERE post.author_id = $author_id;
```
</td>
	</tr>
</table>
 
### 1.3. M07:Comments

<table>
	<tr>
		<th>SQL701</th>
		<td>Post's comments with user information</td>
	</tr>
	<tr>
		<th>Web Resource</th>
		<td><a href="https://hackmd.io/Hk36u2otREmVxBWReAERnA#R304-View-Post">R304</a></td>
	</tr>
	<tr>
		<td colspan=2>

```sql
SELECT
  c.id AS comment_id, c.content, c.date, u.id AS user_id, u.username
FROM public.comment AS c
INNER JOIN public.user AS u ON c.author_id = u.id
WHERE c.post_id = $post_id;
```
</td>
	</tr>
</table>

## 2. Transactions

Transactions are needed to ensure the integrity of the data. These are the transactions identified for Vecto.
  
<table>
    <tr>
        <th>T01</th>
        <td>Get information about post, as well as its comments</td>
    </tr>
    <tr>
        <th>Isolation level</th>
        <td>SERIALIZABLE READ ONLY</td>
    </tr>
	<tr>
		<th>Web Resource</th>
		<td><a href="https://hackmd.io/Hk36u2otREmVxBWReAERnA#R304-View-Post">R304</a></td>
	</tr>
	 <tr>
        <th>Justification</th>
        <td>In the middle of the transaction, the insertion of new rows in the comment table can occur, which implies that the information retrieved in both selects is different, consequently resulting in a Phantom Read. It's READ ONLY because it only uses SELECTS.</td>
    </tr>
    <tr>
        <td colspan=2>
			
```sql
BEGIN TRANSACTION;
SET TRANSACTION ISOLATION LEVEL SERIALIZABLE READ ONLY
 
-- Get information about post
SELECT p.id, p.title, p.votes, p.content, p.school_year,
p.date, p.removed_date, p.removed_reason, p.date,
u.id AS user_id, u.username AS user_name,
fs.id AS from_faculty_id, fs.name as from_faculty_name,
fd.id AS to_faculty_id, fd.name AS to_faculty_name
  FROM (((post AS p
  INNER JOIN public.user AS u ON p.author_id = u.id)
  INNER JOIN public.faculty AS fs ON p.from_faculty_id = fs.id)
  INNER JOIN public.faculty AS fd ON p.to_faculty_id = fd.id)

  WHERE post.id = $post_id;
 
-- Get comments by post_id
SELECT c.id AS comment_id, c.content, c.date, u.id AS user_id, u.username
FROM public.comment AS c
INNER JOIN public.user AS u ON c.author_id = u.id
WHERE c.post_id = $post_id;

 
COMMIT;
```
</td>
	</tr>
</table>

<table>
    <tr>
        <th>T02</th>
        <td>Delete Flags from 3 tables: flag_user, flag_post &amp; flag_comment</td>
    </tr>
    <tr>
        <th>Isolation level</th>
        <td>READ UNCOMMITED</td>
    </tr>
	<tr>
		<th>Web Resource</th>
		<td><a href="https://hackmd.io/Hk36u2otREmVxBWReAERnA#R803-Delete-User-Flag-Action">R803</a>, <a href="https://hackmd.io/Hk36u2otREmVxBWReAERnA#R806-Delete-Comment-Flag-Action">R806</a> &amp; <a href="https://hackmd.io/Hk36u2otREmVxBWReAERnA#R809-Delete-Post-Flag-Action">R809</a></td>
	</tr>
	 <tr>
        <th>Justification</th>
        <td>The transaction should either occur or not occur. READ UNCOMMITED is the fastest isolation level, and no special care is required.</td>
    </tr>
    <tr>
        <td colspan=2>
			
```sql
BEGIN TRANSACTION;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITED
 
-- Delete flag_comments (0 or more)
DELETE FROM public.flag_comment
WHERE flagger_id = $flagger_id AND comment_id = $comment_id


-- Delete flag_posts (0 or more)
DELETE FROM public.flag_post
WHERE flagger_id = $flagger_id AND post_id = $post_id

-- Delete flag_users (0 or more)
DELETE FROM public.flag_user
WHERE flagger_id = $flagger_id AND user_id = $user_id

COMMIT;
```
</td>
	</tr>
</table>

<table>
    <tr>
        <th>T03</th>
        <td>Archive Flags from 3 tables: flag_user, flag_post &amp; flag_comment</td>
    </tr>
    <tr>
        <th>Isolation level</th>
        <td>READ UNCOMMITED</td>
    </tr>
	<tr>
		<th>Web Resource</th>
		<td><a href="https://hackmd.io/Hk36u2otREmVxBWReAERnA#R802-Archive-User-Flag-Action">R802</a>, <a href="https://hackmd.io/Hk36u2otREmVxBWReAERnA#R805-Archive-Comment-Flag-Action">R805</a> &amp; <a href="https://hackmd.io/Hk36u2otREmVxBWReAERnA#R808-Archive-Post-Flag-Action">R808</a></td>
	</tr>
	 <tr>
        <th>Justification</th>
        <td>The transaction should either occur or not occur. READ UNCOMMITED is the fastest isolation level, and no special care is required.</td>
    </tr>
    <tr>
        <td colspan=2>
			
```sql
BEGIN TRANSACTION;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITED
 
-- Archive flag_comments (0 or more)
UPDATE public.flag_comment
SET archived = TRUE
WHERE flagger_id = $flagger_id AND comment_id = $comment_id

-- Archive flag_posts (0 or more)
UPDATE public.post_post
SET archived = TRUE
WHERE flagger_id = $flagger_id AND post_id = $post_id

-- Archive flag_users (0 or more)
UPDATE public.flag_user
SET archived = TRUE
WHERE flagger_id = $flagger_id AND user_id = $user_id

COMMIT;
```
</td>
	</tr>
</table>
 
 
## Revision history
 
1. Initial submission on 26/04/2018

#### GROUP1721, 26/04/2018

>Afonso Ramos - up201506239@fe.up.pt
Daniel Silva - up201503212@fe.up.pt
Miguel Ramalho - up201403027@fe.up.pt
Vitor Minhoto - up201303086@fe.up.pt
